{% load static %}

<div x-data="eventCalendar()" x-init="init()">
    <!-- Calendar Header -->
    <div class="flex items-center justify-between mb-6">
        <button @click="previousMonth()" 
                class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-6 h-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        
        <h2 class="text-2xl font-bold text-gray-900" x-text="currentMonthYear"></h2>
        
        <button @click="nextMonth()" 
                class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-6 h-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </div>
    
    <!-- Calendar Grid -->
    <div class="grid grid-cols-7 gap-2">
        <!-- Day Headers -->
        <div class="text-center font-semibold text-gray-700 py-2">Sun</div>
        <div class="text-center font-semibold text-gray-700 py-2">Mon</div>
        <div class="text-center font-semibold text-gray-700 py-2">Tue</div>
        <div class="text-center font-semibold text-gray-700 py-2">Wed</div>
        <div class="text-center font-semibold text-gray-700 py-2">Thu</div>
        <div class="text-center font-semibold text-gray-700 py-2">Fri</div>
        <div class="text-center font-semibold text-gray-700 py-2">Sat</div>
        
        <!-- Calendar Days -->
        <template x-for="day in calendarDays" :key="day.date">
            <div :class="{'bg-gray-50': !day.isCurrentMonth, 'bg-white': day.isCurrentMonth, 'ring-2 ring-indigo-500': day.isToday}"
                 class="min-h-[100px] border border-gray-200 rounded-lg p-2 hover:bg-gray-50 transition-colors cursor-pointer"
                 @click="selectDate(day.date)">
                
                <div class="flex items-center justify-between mb-1">
                    <span :class="{'text-gray-400': !day.isCurrentMonth, 'text-gray-900 font-semibold': day.isCurrentMonth, 'text-indigo-600': day.isToday}"
                          class="text-sm"
                          x-text="day.dayNumber"></span>
                    
                    <span x-show="day.eventCount > 0"
                          class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-indigo-600 rounded-full"
                          x-text="day.eventCount"></span>
                </div>
                
                <!-- Event Indicators -->
                <div class="space-y-1">
                    <template x-for="event in day.events.slice(0, 2)" :key="event.id">
                        <div :class="getEventColorClass(event.event_type)"
                             class="text-xs px-2 py-1 rounded truncate"
                             :title="event.name"
                             x-text="event.name"></div>
                    </template>
                    
                    <div x-show="day.events.length > 2"
                         class="text-xs text-gray-600 px-2"
                         x-text="`+${day.events.length - 2} more`"></div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Legend -->
    <div class="mt-6 flex items-center justify-center space-x-6 text-sm">
        <div class="flex items-center">
            <div class="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></div>
            <span class="text-gray-700">Tournament</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded mr-2"></div>
            <span class="text-gray-700">Training</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></div>
            <span class="text-gray-700">Seminar</span>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded mr-2"></div>
            <span class="text-gray-700">Grading</span>
        </div>
    </div>
</div>

<script>
function eventCalendar() {
    return {
        currentDate: new Date(),
        calendarDays: [],
        events: {{ events|safe|default:"[]" }},
        
        init() {
            // Parse events from Django template
            this.events = [
                {% for event in events %}
                {
                    id: {{ event.id }},
                    name: "{{ event.name|escapejs }}",
                    start_date: "{{ event.start_date|date:'Y-m-d' }}",
                    event_type: "{{ event.event_type }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            this.generateCalendar();
        },
        
        get currentMonthYear() {
            return this.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },
        
        generateCalendar() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth();
            
            // First day of the month
            const firstDay = new Date(year, month, 1);
            const firstDayOfWeek = firstDay.getDay();
            
            // Last day of the month
            const lastDay = new Date(year, month + 1, 0);
            const lastDate = lastDay.getDate();
            
            // Previous month's last date
            const prevLastDay = new Date(year, month, 0);
            const prevLastDate = prevLastDay.getDate();
            
            const days = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Previous month days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const date = new Date(year, month - 1, prevLastDate - i);
                days.push(this.createDayObject(date, false));
            }
            
            // Current month days
            for (let i = 1; i <= lastDate; i++) {
                const date = new Date(year, month, i);
                days.push(this.createDayObject(date, true));
            }
            
            // Next month days
            const remainingDays = 42 - days.length; // 6 rows * 7 days
            for (let i = 1; i <= remainingDays; i++) {
                const date = new Date(year, month + 1, i);
                days.push(this.createDayObject(date, false));
            }
            
            this.calendarDays = days;
        },
        
        createDayObject(date, isCurrentMonth) {
            const dateStr = date.toISOString().split('T')[0];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isToday = date.getTime() === today.getTime();
            
            // Find events for this date
            const dayEvents = this.events.filter(event => event.start_date === dateStr);
            
            return {
                date: dateStr,
                dayNumber: date.getDate(),
                isCurrentMonth: isCurrentMonth,
                isToday: isToday,
                events: dayEvents,
                eventCount: dayEvents.length
            };
        },
        
        previousMonth() {
            this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
            this.loadMonthEvents();
        },
        
        nextMonth() {
            this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
            this.loadMonthEvents();
        },
        
        loadMonthEvents() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth() + 1;
            
            // Use HTMX to load events for the new month
            htmx.ajax('GET', `/events/calendar/?year=${year}&month=${month}`, {
                target: '#event-calendar',
                swap: 'innerHTML'
            });
        },
        
        selectDate(date) {
            // Open create event modal with pre-filled date
            const createUrl = `/events/create/?date=${date}`;
            htmx.ajax('GET', createUrl, {
                target: '#modal-content',
                swap: 'innerHTML'
            });
            
            // Dispatch event to open modal
            this.$dispatch('open-modal');
        },
        
        getEventColorClass(eventType) {
            const colors = {
                'tournament': 'bg-red-100 text-red-800 border border-red-300',
                'training': 'bg-blue-100 text-blue-800 border border-blue-300',
                'seminar': 'bg-green-100 text-green-800 border border-green-300',
                'grading': 'bg-yellow-100 text-yellow-800 border border-yellow-300'
            };
            return colors[eventType] || 'bg-gray-100 text-gray-800 border border-gray-300';
        }
    };
}
</script>
