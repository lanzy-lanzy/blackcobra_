{% extends 'base_dashboard.html' %}

{% block title %}Event Management - Karate Club{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ view: 'calendar', showModal: false, modalContent: '' }">

    <!-- Header Section -->
    <div class="bg-white shadow-sm rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Event Management</h1>
                <p class="mt-2 text-gray-600">Manage karate club events, tournaments, and training sessions.</p>
            </div>
            <div class="flex items-center space-x-3">
                <!-- View Switcher -->
                <div class="inline-flex rounded-lg border border-gray-300 bg-white p-1">
                    <button @click="view = 'calendar'"
                        :class="view === 'calendar' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'"
                        class="px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Calendar
                    </button>
                    <button @click="view = 'list'"
                        :class="view === 'list' ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-gray-100'"
                        class="px-4 py-2 text-sm font-medium rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="w-5 h-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        List
                    </button>
                </div>

                <!-- Create Event Button -->
                <button hx-get="{% url 'event_create' %}" hx-target="#modal-content" hx-swap="innerHTML"
                    @click="showModal = true"
                    class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Create Event
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar View -->
    <div x-show="view === 'calendar'" x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        class="bg-white shadow-sm rounded-lg p-6">

        <div id="event-calendar" hx-get="{% url 'event_calendar_data' %}"
            hx-trigger="load, eventCreated from:body, eventUpdated from:body, eventDeleted from:body"
            hx-swap="innerHTML">
            <!-- Calendar will be loaded here -->
            <div class="animate-pulse space-y-4">
                <div class="h-8 bg-gray-300 rounded w-1/4 mx-auto"></div>
                <div class="grid grid-cols-7 gap-2">
                    <div class="h-20 bg-gray-200 rounded" x-data="{}"
                        x-init="for(let i=0; i<35; i++) { $el.parentElement.appendChild($el.cloneNode(true)); }"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- List View -->
    <div x-show="view === 'list'" x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="space-y-4">

        <div id="event-list" hx-get="{% url 'event_list' %}?view=list"
            hx-trigger="load delay:100ms, eventCreated from:body, eventUpdated from:body, eventDeleted from:body"
            hx-swap="innerHTML">
            <!-- Event cards will be loaded here -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Skeleton Loading Cards -->
                <div class="bg-white rounded-lg shadow-md p-6 animate-pulse">
                    <div class="h-6 bg-gray-300 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 animate-pulse">
                    <div class="h-6 bg-gray-300 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 animate-pulse">
                    <div class="h-6 bg-gray-300 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
                    <div class="h-4 bg-gray-200 rounded w-5/6 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto"
        @keydown.escape.window="showModal = false">

        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" @click="showModal = false"></div>

        <!-- Modal Content -->
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
                @click.stop x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 scale-95">

                <div id="modal-content"
                    @event-created.window="showModal = false"
                    @event-updated.window="showModal = false">
                    <!-- Modal content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Listen for HTMX events to control modal
    document.body.addEventListener('eventCreated', () => {
        // Close modal
        const modal = document.querySelector('[x-data*="showModal"]');
        if (modal && modal.__x) {
            modal.__x.$data.showModal = false;
        }
        // Dispatch Alpine-compatible event
        window.dispatchEvent(new CustomEvent('event-created'));
    });

    document.body.addEventListener('eventUpdated', () => {
        // Close modal
        const modal = document.querySelector('[x-data*="showModal"]');
        if (modal && modal.__x) {
            modal.__x.$data.showModal = false;
        }
        // Dispatch Alpine-compatible event
        window.dispatchEvent(new CustomEvent('event-updated'));
    });

    function eventCalendar(initialEvents, initialYear, initialMonth) {
        return {
            currentDate: new Date(initialYear || new Date().getFullYear(), (initialMonth ? initialMonth - 1 : new Date().getMonth()), 1),
            calendarDays: [],
            events: initialEvents || [],

            init() {
                this.generateCalendar();
            },

            get currentMonthYear() {
                return this.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            },

            generateCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();

                // First day of the month
                const firstDay = new Date(year, month, 1);
                const firstDayOfWeek = firstDay.getDay();

                // Last day of the month
                const lastDay = new Date(year, month + 1, 0);
                const lastDate = lastDay.getDate();

                // Previous month's last date
                const prevLastDay = new Date(year, month, 0);
                const prevLastDate = prevLastDay.getDate();

                const days = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Previous month days
                for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                    const date = new Date(year, month - 1, prevLastDate - i);
                    days.push(this.createDayObject(date, false));
                }

                // Current month days
                for (let i = 1; i <= lastDate; i++) {
                    const date = new Date(year, month, i);
                    days.push(this.createDayObject(date, true));
                }

                // Next month days
                const remainingDays = 42 - days.length; // 6 rows * 7 days
                for (let i = 1; i <= remainingDays; i++) {
                    const date = new Date(year, month + 1, i);
                    days.push(this.createDayObject(date, false));
                }

                this.calendarDays = days;
            },

            createDayObject(date, isCurrentMonth) {
                // Fix date string generation to avoid timezone issues
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isToday = date.getTime() === today.getTime();

                // Find events for this date
                const dayEvents = this.events.filter(event => event.start_date === dateStr);

                return {
                    date: dateStr,
                    dayNumber: date.getDate(),
                    isCurrentMonth: isCurrentMonth,
                    isToday: isToday,
                    events: dayEvents,
                    eventCount: dayEvents.length
                };
            },

            previousMonth() {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
                this.reloadEvents();
            },

            nextMonth() {
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
                this.reloadEvents();
            },

            reloadEvents() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth() + 1;

                // Use HTMX to load events for the new month
                htmx.ajax('GET', `{% url 'event_calendar_data' %}?year=${year}&month=${month}`, {
                    target: '#event-calendar',
                    swap: 'innerHTML'
                });
            },

            selectDate(date) {
                // Open create event modal with pre-filled date
                const createUrl = `{% url 'event_create' %}?date=${date}`;
                htmx.ajax('GET', createUrl, {
                    target: '#modal-content',
                    swap: 'innerHTML'
                }).then(() => {
                    // Show modal after content is loaded
                    const modal = document.querySelector('[x-data="{ view: \'calendar\', showModal: false, modalContent: \'\' }"]');
                    if (modal) {
                        modal.__x.$data.showModal = true;
                    }
                });
            },

            getEventColorClass(eventType) {
                const colors = {
                    'tournament': 'bg-red-100 text-red-800 border border-red-300',
                    'training': 'bg-blue-100 text-blue-800 border border-blue-300',
                    'seminar': 'bg-green-100 text-green-800 border border-green-300',
                    'grading': 'bg-yellow-100 text-yellow-800 border border-yellow-300'
                };
                return colors[eventType] || 'bg-gray-100 text-gray-800 border border-gray-300';
            }
        };
    }
</script>

{% endblock %}